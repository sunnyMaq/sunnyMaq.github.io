<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>许愿墙</title>
<link rel="stylesheet" href="./css/index.css" />
<script src="js/ajax.js"></script>
<script>
    function rnd(n,m){
        return parseInt(Math.random()*(m-n)+n);
    }
    window.onload=function(){
        var oSend=document.getElementById('send');
        var oLayer=document.getElementById('layer');
        var oSendForm=document.getElementById('send-form');
        var oMain=document.getElementById('main');
        var oUserName=document.getElementById('username');
        var oContent=document.getElementById('content');
        var clientW=document.documentElement.clientWidth;
        var clientH=document.documentElement.clientHeight;
        var oClose=document.getElementById('close');
        var oSendBtn=document.getElementById('send-btn');
        var oPhiz=document.getElementById('phiz');
        var aImg=oPhiz.getElementsByTagName('img');
        var zIndex=0;

        oSend.onclick=function(){
            oLayer.style.display='block';
            oSendForm.style.display='block';
            oSendForm.style.zIndex=9999999;

            oSendForm.style.left=clientW/2-200+'px';
        };
        oClose.onclick=function(){
            oLayer.style.display='none';
            oSendForm.style.display='none';
        };
        var url='wish.php';
        oSendBtn.onclick=function(){
            ajax({
                url:url,
                data:{
                    act:'add',
                    username:oUserName.value,
                    content:oContent.value
                },
                fnSucc:function(str){
                    var json=new Function('return '+str)();

                    if(json.error){
                        alert('发表心愿失败！')
                    }else{
                        var oDl=createMsg(oUserName.value,oContent.value);
                        oMain.appendChild(oDl);
                    }
                    getAllMsg();
                    oLayer.style.display='none';
                    oSendForm.style.display='none';
                    oUserName.value='';
                    oContent.value='';
                }
            });
        };
        function createMsg(userName,content,id,time){
            var oDl=document.createElement('dl');
            oDl.className='paper a'+rnd(1,6)+'';
            var oDate=new Date();
            oDate.setTime(time*1000);
            var str=oDate.getHours()+':'+oDate.getMinutes();
            oDl.innerHTML='<dt>'
                    +'<span class="username">'+userName+'</span>'
                    +'<span class="num">No.00001</span>'
                    +'</dt>'
                    +'<dd class="content">'+toFace(content)+'</dd>'
                    +'<dd class="bottom">'
                    +'<span class="time">今天'+str+'</span>'
                    +'<a href="javascript:;" class="close"></a>';
            +'</dd>';

            var aA=oDl.getElementsByTagName('a')[0];
            aA.onclick=function(){
                ajax({
                    url:url,
                    data:{
                        act:'delete',
                        id:id
                    },
                    fnSucc:function(str){
                        var json=new Function('return '+str)();
                        if(json.error){
                            alert('删除失败！');
                        }else{
                            oMain.removeChild(oDl);
                        }
                    }
                });
            };
            oDl.style.left=rnd(0,clientW-400)+'px';
            oDl.style.top=rnd(0,clientH-360)+'px';
            return oDl;
        }

        function getAllMsg(){
            oMain.innerHTML='';
            ajax({
                url:url,
                data:{
                    act:'get'
                },
                fnSucc:function(str){
                    var json=new Function('return '+str)();
                    if(json.error){
                        alert('获取所有心愿失败！');
                    }else{
                        var arr=json.msg;
                        for(var i=0;i<arr.length;i++){
                            var oDl=createMsg(arr[i].username,arr[i].content,arr[i].id,arr[i].time);
                            drag(oDl);
                            oMain.appendChild(oDl);
                        }
                    }
                }
            })
        }
        getAllMsg();
        function drag(obj){
            obj.onmousedown=function(ev){
                var oEvent=ev||event;
                var disX=oEvent.clientX-obj.offsetLeft;
                var disY=oEvent.clientY-obj.offsetTop;
                obj.style.zIndex=zIndex++;
                document.onmousemove=function(ev){
                    var oEvent=ev||event;
                    var l=oEvent.clientX-disX;
                    var t=oEvent.clientY-disY;

                    obj.style.left=l+'px';
                    obj.style.top=t+'px';
                };
                document.onmouseup=function(){
                    document.onmousemove=null;
                    document.onmouseup=null;
                };
                return false;

            }
        }
        //添加表情

        for(var i=0;i<aImg.length;i++){
            aImg[i].onclick=function(){
                oContent.value+='['+this.alt+']';
            }
        }

        function toFace(str){
            var arr1=['[抓狂]','[抱抱]','[害羞]','[酷]','[嘻嘻]','[太开心]','[偷笑]','[钱]','[花心]','[挤眼]'];
            var arr2=['zhuakuang','baobao','haixiu','ku','xixi','taikaixin','touxiao','qian','huaxin','jiyan'];

            for(var i=0;i<arr1.length;i++){
                if(str.indexOf(arr1[i])!=-1){
                    str=str.replace(arr1[i],'<img src="./Images/'+arr2[i]+'.gif" alt="酷" />');
                    i--;
                }
            }
            return str;
        }
    };

</script>
</head>
<body>
<div id='top'>
    <span id='send'></span>
</div>
<div id='main'>
    <!--<dl class='paper a1'>-->
        <!--<dt>-->
            <!--<span class='username'>sunny</span>-->
            <!--<span class='num'>No.00001</span>-->
        <!--</dt>-->
        <!--<dd class='content'>hello world</dd>-->
        <!--<dd class='bottom'>-->
            <!--<span class='time'>今天08:30</span>-->
            <!--<a href="" class='close'></a>-->
        <!--</dd>-->
    <!--</dl>-->
</div>

<div id="layer"></div>

<div id='send-form'>
    <p class='title'><span>许下你的愿望</span><a href="javascript:;" id='close'></a></p>
    <form action="" name='wish'>
        <p>
            <label for="username">昵称：</label>
            <input type="text" name='username' id='username'/>
        </p>
        <p>
            <label for="content">愿望：(您还可以输入&nbsp;<span id='font-num'>50</span>&nbsp;个字)</label>
            <textarea name="content" id='content'></textarea>
            <div id='phiz'>
                <img src="./Images/zhuakuang.gif" alt="抓狂" />
                <img src="./Images/baobao.gif" alt="抱抱" />
                <img src="./Images/haixiu.gif" alt="害羞" />
                <img src="./Images/ku.gif" alt="酷" />
                <img src="./Images/xixi.gif" alt="嘻嘻" />
                <img src="./Images/taikaixin.gif" alt="太开心" />
                <img src="./Images/touxiao.gif" alt="偷笑" />
                <img src="./Images/qian.gif" alt="钱" />
                <img src="./Images/huaxin.gif" alt="花心" />
                <img src="./Images/jiyan.gif" alt="挤眼" />
            </div>
        </p>
        <span id='send-btn'></span>
    </form>
</div>
</body>
</html>